<?php 
	class yatcoConnect_ApiToBossBoatdeckParams extends yatcoConnect_Base_Params {

		public $params_from_pro=array (
		  'VesselID' => 1,
		  "EventID" => 1,
		  'VesselIDs' => [],
		  'MLSIDs' => [],
		  'MLSID' => 1,
		  'VesselStatusList' => 
		  array (
		    0 => 1,
		    1 => 2,
		  ),
		  'VesselStatus' => 2,
		  'CountryID' => 1,
		  'StateID' => 1,
		  'StateList' => 
		  array (
		    0 => 1,
		    1 => 2,
		  ),
		  'RegionID' => 1,
		  'CompanyID' => 1,
		  'CountryList' => 
		  array (
		    0 => 1,
		    1 => 2,
		  ),
		  'ListingAgreementType' => 3,
		  'LengthUnit' => 4,
		  'CurrencyType' => 5,
		  'SpeedUnit' => 6,
		  'VolumeUnit' => 7,
		  'WeightUnit' => 8,
		  'ModificationTypeList' => 
		  array (
		    0 => 1,
		    1 => 2,
		  ),
		  'MinClearance' => 1,
		  'MaxClearance' => 1,
		  'MinBeam' => 1,
		  'MaxBeam' => 1,
		  'MinSpeed' => 1,
		  'MinFuelCapacity' => 1,
		  'MinHeads' => 1,
		  'MinWaterCapacity' => 1,
		  'MinStaterooms' => 1,
		  'MinSleeps' => 1,
		  'MaxSleeps' => 1,
		  
		  'MainCategoryID' => 1,
		  'MainCategoryIDs' => 1,

		  'SubCategoryID' => 1,
		  'SubCategoryIDs' => 1,

		  'MainCategoryText' => 'sample string 9',
		  'ProductionTypeId' => 
		  array (
		    0 => 1,
		    1 => 1,
		  ),
		  'SuperstructureMaterialID' => 
		  array (
		    0 => 1,
		    1 => 1,
		  ),
		  'BuildStatus' => 1,
		  'SubBuildStatus' => 1,
		  'KeelLayingDate' => 
		  array (
		    'Start' => '2020-03-26T22:55:34.8539558+00:00',
		    'End' => '2020-03-26T22:55:34.8539558+00:00',
		  ),
		  'ConstructionStartDate' => 
		  array (
		    'Start' => '2020-03-26T22:55:34.8539558+00:00',
		    'End' => '2020-03-26T22:55:34.8539558+00:00',
		  ),
		  'LaunchDate' => 
		  array (
		    'Start' => '2020-03-26T22:55:34.8539558+00:00',
		    'End' => '2020-03-26T22:55:34.8539558+00:00',
		  ),
		  'MonthsFromContract' => 
		  array (
		    'Start' => 1,
		    'End' => 1,
		  ),

		  "SoldDateRange" => 
		  array (
		    'Start' => 1,
		    'End' => 1,
		  ),

		  'MinDraft' => 1.0,
		  'MaxDraft' => 1.0,
		  'EngineModel' => 'sample string 10',
		  'CruiseSpeedRange' => 1,
		  'HullTypeId' => 
		  array (
		    0 => 1,
		    1 => 2,
		  ),
		  'HullID' => 'sample string 11',
		  'HullMaterial' => 
		  array (
		    0 => 1,
		    1 => 2,
		  ),
		  'HullConfiguration' => 
		  array (
		    0 => 1,
		    1 => 2,
		  ),
		  'EngineFuelType' => 
		  array (
		    0 => 1,
		    1 => 2,
		  ),
		  'NumberofEngines' => 
		  array (
		    0 => 1,
		    1 => 2,
		  ),
		  'SailBoatIDList' => 
		  array (
		    0 => 1,
		    1 => 2,
		  ),
		  'MotorBoatIDList' => 
		  array (
		    0 => 1,
		    1 => 2,
		  ),
		  'Rigs' => 
		  array (
		    0 => 1,
		    1 => 2,
		  ),
		  'EngineManufacturer' => 
		  array (
		    0 => 1,
		    1 => 2,
		  ),
		  'BuilderIDList' => 
		  array (
		    0 => 1,
		    1 => 2,
		  ),
		  'SoldDate' => '2020-03-26T22:55:34.8549356+00:00',
		  'ActiveDateFrom' => '2020-03-26T22:55:34.8549356+00:00',
		  'ModifiedDate' => '2020-03-26T22:55:34.8549356+00:00',
		  'PriceRange' => 
		  array (
		    'Start' => 1,
		    'End' => 1,
		  ),
		  'LOA' => 
		  array (
		    'Start' => 1,
		    'End' => 1,
		  ),
		  'Year' => 
		  array (
		    'Start' => 1,
		    'End' => 1,
		  ),
		  'ModelYear' => 
		  array (
		    'Start' => 1,
		    'End' => 1,
		  ),
		  'GrossTonnage' => 
		  array (
		    'Start' => 1,
		    'End' => 1,
		  ),
		  'GrossTonnagePounds' => 
		  array (
		    'Start' => 1,
		    'End' => 1,
		  ),
		  'PriceRangeUSD' => 
		  array (
		    'Start' => 1,
		    'End' => 1,
		  ),
		  'PriceRangeUSD_PreCalc' => 
		  array (
		    'Start' => 1,
		    'End' => 1,
		  ),
		  'VesselName' => 'sample string 12',
		  'Builder' => 'sample string 13',
		  'BuilderExactMatch' => 'sample string 14',
		  'BuilderID' => 15,
		  'Model' => 'sample string 16',
		  'BrokerageCompany' => 'sample string 17',
		  'BrokerName' => 'sample string 18',
		  'City' => 'sample string 19',
		  'Zip' => 'sample string 20',
		  'Keywords' => 'sample string 21',
		  'Sail' => true,
		  'Motor' => true,
		  'View_All' => true,
		  'Concept' => true,
		  'Fractional' => true,
		  'Commercial' => true,
		  'ForCharter' => true,
		  'Construction' => true,
		  'New' => true,
		  'Used' => true,
		  'Sold' => true,
		  'Open' => true,
		  'CompanyOnly' => true,
		  'Search_All' => true,
		  'Search_GalatiPreowned' => true,
		  'Search_GalatiNewYachts' => true,
		  'Search_Yatco' => true,
		  'SpecialOffer' => true,
		  'FactoryDemo' => true,
		  'TradeIn' => true,
		  'NewToMarket' => true,
		  'PriceChange' => true,
		  'BrokerID' => 24,
		  'OfficeID' => 25,
		  'BrokersFilter' => 
		  array (
		    0 => 1,
		    1 => 2,
		  ),
		  'MaxRecordAgeHours' => 1,
		  'Condition' => 26,
		  'Type' => 27,
		  'ShowOnlyInclude' => 28,
		  'VesselCondition' => 
		  array (
		    0 => 1,
		    1 => 2,
		  ),
		  'VesselType' => 
		  array (
		    0 => 2,
		    1 => 1,
		  ),
		  'DataSource' => 
		  array (
		    0 => 1,
		    1 => 2,
		  ),
		  'TagsList' => 
		  array (
		    0 => 1,
		    1 => 2,
		  ),
		  'KeywordsList' => 
		  array (
		    0 => 'sample string 21',
		  ),
		  'offset' => 29,
		  'records' => 30,
		  'sortField' => 'sample string 31',
		  'sortDirection' => 'sample string 32',
		  'sortId' => 33,
		  'BOSSSearch' => 'sample string 34',
		  'ShowOnConsumer' => true,
		  'ShowOnPro' => true,
		  'CompanyTypeIDs' => 
		  array (
		    0 => 1,
		    1 => 2,
		  ),
		  'TaxPaidID' => 1,
		  'FeaturedNotFirst' => 1,
		  'ExcludeMLSIDs' => '',
		  'StrExcludeMLSIDs' => '',
		  'ExcludeVesselIDs' => '',
		  'StrExcludeVesselIDs' => '',

		  'OnOrder' => '',

		  'Cities' => [],

		  'EngineType'=> [],

		);

		public $added_criteria=[
			'ExcludeCompanyIDs' => '',

			'loa_from' => '',
			'loa_to' => '',

			'pricerange_from' => '',
			'pricerange_to' => '',

			'PriceRange_from' => '',
			'PriceRange_to' => '',

			'year_from' => '',
			'year_to' => '',

			'grosstonnage_from' => '',
			'grosstonnage_to' => '',

			'page_index' => '',
			'page_size' => 12,

			'limit_mobile_size' => 0,

			'featured' => '',	

			'vessel_ids' => '',	

			'override_with_attrs' => '',

			'HistoryType' => '',
			
			'load-more-button' => '',

			'TaxPaidID' => "",
			'FeaturedNotFirst' => "",
			'ExcludeMLSIDs' => '',
			'StrExcludeMLSIDs' => '',
			'ExcludeVesselIDs' => '',
			'StrExcludeVesselIDs' => '',

			'OnOrder' => '',


			'even_more_args' => false,

			'fromForm' => '',

			'OnFirstLoad' => '',

			'mls_ids' => '',

			'ForCoBroker' => '',

			'scroll_down' => '',

			'viewtype' => '',

			"Currency" => '',

		    "Length" => "",

		    "MainCategory" => "",

		    "SubCategory" => "",

		    "Type" => "",

		    "VesselCondition" => "",

		    "Region" => "",
		    "Country" => "",
		    'State' => '',		    
			'Cities' => "",
			'City' => '',

		    'search_parameters' => '',
		    'had_search_parameters' => '',

		    'default_args' => [],

		    // pretty parameters
		    'category' => '',
		    'Category' => '',

		    'sub-category' => '',
		    'subcategory' => '',

		    'brand' => '',

		    'type' => '',
		    'Type' => '',

		    'condition' => '',

		    'AcceptsCrypto' => '',

		    'LocationRegionID' => '',
		    'LocationCountryID' => '',
		    'LocationStateID' => '',
		    'LocationCityID' => '',
		    

		    'locationregionid' => '',
		    'locationcountryid' => '',
		    'Locationstateid' => '',
		    'locationcityid' => '',

		    "SKIP_STATS_AND_META" => '',

		    'loa_ranged' => '',
		    'length_ranged' => '',
		    'pricerange_ranged' => '',
		    'year_ranged' => '',


		    'has_search_parameters_been_applied' => ''
		];

		public $int_fields = [
			'num_staterooms',
			'num_sleeps',
			'page_index',
			'records',
			'page_size', 
			'FeaturedNotFirst',
			'limit_mobile_size',
			'loa_from',
			'loa_to',

			'pricerange_from',
			'pricerange_to',

			'VesselStatus',

			'ForCoBroker'

		];

		public $range_fields = array(
			'pricerange',
			'PriceRange',
			'loa',
			'LOA',
			'length',
			'Length',
			'Year',
			'year',
			'modelyear',
			'grosstonnage',
			'SoldDateRange',
			'solddaterange',
		);

		public $array_fields = [
			'BuilderIDList',
			'MotorBoatIDList',
			'SailBoatIDList',
			'ModificationTypeList',
			'CountryList',
			'StateList',
			'VesselStatusList',
			'TagsList',
			'MLSIDs',
			'EngineType',
			'HullMaterial',
			'ExcludeCompanyIDs',
			'VesselIDs',
			'ExcludeVesselIDs',
			'ExcludeMLSIDs'
		];

		public $required_params = [

		];

		public function __construct() {
			parent::__construct();

			$this->options = new yatcoConnect_Options();
		}

		public function prepare_search_parameters( $atts ) {
			// wp-query var search parameters
			global $wp_query;

			// Pretty Parameters!!!
			if (isset($atts['category'])) {
				$atts['MainCategory'] = $atts['category'];
			}

			if (isset($atts['sub-category'])) {
				$atts['SubCategory'] = $atts['sub-category'];
			}

			if (isset($atts['subcategory'])) {
				$atts['SubCategory'] = $atts['subcategory'];
			}
		
			if (isset($atts['brand'])) {
				$atts['Builder'] = $atts['brand'];
				$atts['builder'] = $atts['brand'];
			}
			
			if ( isset($atts['search_parameters']) ) {
				$path_parameters = $atts['search_parameters'];
				$path_parameters=array_map(function($item) { return urldecode($item); }, $path_parameters);
			}
			else {
				$path_parameters = (array) $wp_query->get('search_parameters');
				$atts['search_parameters'] = $path_parameters;
				$path_parameters=array_map(function($item) { return urldecode($item); }, $path_parameters);

			}

				if (isset($path_parameters['category'])) {
					$path_parameters['MainCategory'] = $path_parameters['category'];
				}

				if (isset($path_parameters['sub-category'])) {
					$path_parameters['SubCategory'] = $path_parameters['sub-category'];
				}

				if (isset($path_parameters['subcategory'])) {
					$path_parameters['SubCategory'] = $path_parameters['subcategory'];
				}

			if (is_array($path_parameters) && ! isset($atts['has_search_parameters_been_applied'])) {
				//$atts = array_merge((array) $path_parameters, (array) $atts);
				//var_dump($atts);

				// TEXT To IDs
				$data = new yatcoConnect_ApiToBoss();
				
				$returned = (array) $data->get_search_pretty_parameters_to_ids(
					//$atts
					array_merge((array) $path_parameters, (array) $atts)
				);

				//$returned=[];

				$allowed_fields = [
					//"Condition", // removed and it started work 2/13/23

					"VesselType",

					'MainCategoryID',
					'SubCategoryID',
					
					'LocationRegionID',
					'LocationCountryID',
					'LocationStateID',
					'LocationCityID'
				];

				foreach ($allowed_fields as $af) {
					if (isset($returned[$af]) && ! isset($atts[ $af ])) {
						$atts[ $af ] = $returned[ $af ];
					}
				}

				//$atts = array_merge((array) $returned, (array) $atts);
				
				//unset($atts['search_parameters']);

				unset($atts['Region']);
				unset($atts['region']);

				unset($atts['Country']);
				unset($atts['country']);

				unset($atts['State']);
				unset($atts['state']);

				unset($atts['City']);
				unset($atts['city']);

				$atts['has_search_parameters']=1;
				$atts['has_search_parameters_been_applied']=1;
			}
			/*elseif (isset($atts['has_search_parameters_been_applied'])) {

				unset($atts['Region']);
				unset($atts['region']);

				unset($atts['Country']);
				unset($atts['country']);

				unset($atts['State']);
				unset($atts['state']);

				unset($atts['City']);
				unset($atts['city']);
			}*/

			$params_txt_value=[
				'condition' => [
					'all' => '',
					'new' => 1,
					'used' => 2
				],

				'vesseltype' => [
					'all' => '',
					'motor' => 2,
					'sail' => 1
				],

				'Condition' => [
					'all' => '',
					'new' => 1,
					'used' => 2
				],

				'VesselType' => [
					'all' => '',
					'motor' => 2,
					'sail' => 1
				],
			];

			foreach ($atts as $p_index => $p_val) {

				//$p_index = strtolower($p_index);

				if (
					isset($params_txt_value[ $p_index ])
					&& 
					isset($params_txt_value[ $p_index ][$p_val])
				) {

					//var_dump( $params_txt_value[ $p_index ][$p_val] );

					$atts[$p_index] = $params_txt_value[ $p_index ][$p_val];

				}

			}

			/*$atts['default_args']=[

				'PriceRange_from' => 5000,
				'PriceRange_to' => 10000,

				//'LOA_from' => 10,
				// 'LOA_to' => 90,

			];

			$atts['default_args'] = json_decode($this->options->getOption('yacht_search_result_args'), true);
			$atts['default_args'] = $atts['default_args']['default_args'];*/

			if (isset($atts['default_args']) && is_array($atts['default_args'])) {

				$default_args = json_decode(json_encode($atts['default_args']), true);

				foreach ($this->range_fields as $field) {

					if (
						isset( $default_args["{$field}_from"])
						||
						isset( $default_args["{$field}_to"] )
					) {

						//var_dump('pass1');

						if (isset( $atts["{$field}_from"])) {
							$from = filter_var($atts["{$field}_from"], FILTER_SANITIZE_NUMBER_FLOAT, FILTER_FLAG_ALLOW_FRACTION);
						}
						else {
							$from = 0;
						}

						if (isset( $atts["{$field}_to"] )) {
							$to = filter_var($atts["{$field}_to"], FILTER_SANITIZE_NUMBER_FLOAT, FILTER_FLAG_ALLOW_FRACTION);
						}
						else {
							//$to = 999999999999999;
							$to=0;
						}
						
						//$to = $criteria[$field]['Start'];
						//$from = $criteria[$field]['End'];

						if (isset( $default_args["{$field}_from"])) {
							$default_from = filter_var($default_args["{$field}_from"], FILTER_SANITIZE_NUMBER_FLOAT, FILTER_FLAG_ALLOW_FRACTION);
						}
						else {
							$default_from = 0;
						}

						if (isset( $default_args["{$field}_to"] )) {
							$default_to = filter_var($default_args["{$field}_to"], FILTER_SANITIZE_NUMBER_FLOAT, FILTER_FLAG_ALLOW_FRACTION);
						}
						else {
							$default_to=0;
						}

						$to = (int) $to;
						$from = (int) $from;
						
						$default_to = (int) $default_to;
						$default_from = (int) $default_from;

						if ($default_from >= $from && $from !== 0) {
							// pass $from
							$atts["{$field}_from"] = $from;
 						}
						else {
							// pass $default_from
							$atts["{$field}_from"] = $default_from;
						}
					
						
						if ($default_to <= $to && $to !== 0) {
							// pass $to
							$atts["{$field}_to"] = $to;
						}
						else {
							// pass $default_to
							$atts["{$field}_to"] = $default_to;

						}
						
						//var_dump($atts);

						unset($default_args[$field]);
						unset($default_args["{$field}_from"]);
						unset($default_args["{$field}_to"]);
					}
				}

				foreach ($default_args as $name => $val) {

					if (isset($criteria[$name])) {

						$atts[$name] = $default_args[$name];

					}

				}
			}

			$atts = apply_filters('yatco_yacht_params', $atts);

			// Super Check		
			$criteria = parent::prepare_search_parameters( $atts );
						
			if (defined('YATCO_ONLY_USE_COMPANY_ID') && ! isset($criteria['CompanyID'])) {
				$criteria['CompanyID'] = YATCO_ONLY_USE_COMPANY_ID;
			}

			if (isset($criteria['featured']) && $criteria['featured'] == '1') {
				$criteria['TagsList'] = [4];
			}

			// Vessel Ids  string to array
			if (isset($criteria['vessel_ids'])) {
				$criteria['VesselIDs'] = explode(",", $criteria['vessel_ids']);
				
				$criteria['VesselIDs'] = array_map(
					function($val) {return (int) $val;}, 
					$criteria['VesselIDs']
				);
			}
			
			// MSL Ids  string to array
			if (isset($criteria['mls_ids'])) {
				$criteria['MLSIDs'] = explode(",", $criteria['mls_ids']);
				
				$criteria['MLSIDs'] = array_map(
					function($val) {return (int) $val;}, 
					$criteria['MLSIDs']
				);
			}

			if (isset($criteria['OnFirstLoad']) && is_array( $criteria['OnFirstLoad'] )) {
				if ($criteria['page_index'] == 1 && ($criteria['fromForm'] !== 1 && $criteria['fromForm'] !== '1')) {
					$criteria = array_merge($criteria, $criteria['OnFirstLoad']);
				}
				elseif ($criteria['fromForm'] === 1 || $criteria['fromForm'] === '1') {
						foreach ($criteria['OnFirstLoad'] as $key => $value) {

						if (! isset($criteria[$key]) && ! isset($criteria[ strtolower($key) ]) ) {

							$criteria[$key] = $criteria['OnFirstLoad'][$key];

						}

					}
				}
			}

			// SORT AND FILTER
			if (isset($criteria['sortid'])) {
				$criteria['sortId']=$criteria['sortid'];
			}

			if (isset($criteria['sortId'])) {
				if ($criteria['sortId'] == 8 || $criteria['sortId'] == 9) {
					$criteria['VesselSizeType']=1;
				}
				elseif ($criteria['sortId'] == 10 || $criteria['sortId'] == 11) {
					$criteria['VesselSizeType']=2;
				}
			}


			$criteria['ShowOnConsumer'] = true;

			//$criteria['MLSIDs'] = join(',', [233504, 261251, 94756, 251283, 237224, 94756, 243265, 270092, 273399, 263704, 276064, 275268, 272688, 266763, 272818, 253606, 267259, 266567, 231852, 274533, 276033, 272982, 267678, 261682]);

			global $wp_query;

			$wp_query->YATCO_PARAMS = $criteria;

			return $criteria;

		}


	}